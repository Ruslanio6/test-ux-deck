<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Тест UX Колоды</title>
  <style>
    body {
      font-family: Cygre, Inter, sans-serif;
      margin: 24px;
      text-align: left;
      display: flex;
      justify-content: center;
      background-color: #f6f7fd;
      
      
    }

    .section {
      display: none;
      font-size: 16px;
      padding: 20px;
      border: 2px solid #ede9f6;
      border-radius: 24px;
      width: 100%;
      max-width: 1024px;
      background-color: #ffffff;
    }

    .visible {
      display: block;
    }

    img {
      width: auto;
      height: 176px;
    }

    .checkbox-group {
      margin-top: 24px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 1px solid #ede9f6;
      border-radius: 12px;
      background-color: #f6f7fd;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .checkbox-item:hover {
      background-color: #e6e6fa;
    }

    .checkbox-item input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    .next-button {
      margin-top: 30px;
      padding: 16px 24px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .next-button:hover {
      background-color: #45a049;
    }

    h1, h2, p {
      text-align: left;
      color: #211C1D;
    }

    p {
    line-height: 24px;
    font-family: inter;
    font-weight: 500;
    font-size: 16px;
}
  </style>
  <script>
  let sectionIndex = 0;
  let startTime;
  let results = [];
  let sections = [];
  let currentDeckIndex = 0;

  const decks = Array.from({ length: 8 }, (_, i) => ({
    folder: `images/deck-${i + 1}`,
    name: `Колода ${i + 1}`
  }));


// Подсчет баллов кололды
function analyzeDeck(deckResults, correctAnswersBySection) {
  let totalF1 = 0;
  let totalAnswerTime = 0;
  let memorizeTime = 0;

  deckResults.forEach(result => {
    const section = result.section;
    const time = result.time;
    const answers = result.answers;

    if (section === 1) {
      memorizeTime = time; // Время запоминания
    }

    if ([2, 3, 4].includes(section)) {
      const correct = correctAnswersBySection[section - 2] || [];
      const f1 = calculateF1(answers, correct);
      totalF1 += f1;
      totalAnswerTime += time;
    }
  });

  const avgF1 = totalF1 / 3;
  const avgTime = totalAnswerTime / 3;

  // Финальный балл: 30% запоминание, 50% точность, 20% скорость
  const normMemorize = Math.max(0, (12 - memorizeTime) / 12) * 100;
  const normTime = Math.max(0, (20 - avgTime) / 20) * 100;
  const score = (normMemorize * 0.3) + (avgF1 * 0.5) + (normTime * 0.2);

  return {
    memorizeTime: memorizeTime.toFixed(2),
    avgF1: avgF1.toFixed(2),
    avgAnswerTime: avgTime.toFixed(2),
    score: score.toFixed(2)
  };
}

// Конец функции подсчета баллов

// Вспомогательаня F1
function calculateF1(userAnswers, correctAnswers) {
  const correctSet = new Set(correctAnswers.map(x => x.trim().toLowerCase()));
  const userSet = new Set(userAnswers.map(x => x.trim().toLowerCase()));

  const tp = [...userSet].filter(x => correctSet.has(x)).length;
  const fp = [...userSet].filter(x => !correctSet.has(x)).length;
  const fn = [...correctSet].filter(x => !userSet.has(x)).length;

  const precision = tp / (tp + fp || 1);
  const recall = tp / (tp + fn || 1);

  if (tp === 0) return 0;

  return (2 * precision * recall) / (precision + recall) * 100;
}

// Конец F1
    
  function updateImages() {
    const folder = decks[currentDeckIndex].folder;
    const images = sections[1].querySelector("img");
    const boards = [2, 3, 4]; // Разделы 3, 4, 5

    // Картинка для "на руке"
    sections[1].querySelector("img").src = `${folder}/hand.png`;

    // Картинки для трёх бордов
    boards.forEach((sectionNum, idx) => {
      const img = sections[sectionNum].querySelector("img");
      img.src = `${folder}/board${idx + 1}.png`;
    });
  }

  function showSection(index) {
    if (index >= sections.length) {
      endTest();
      return;
    }

    sections.forEach(sec => sec.classList.remove("visible"));
    sections[index].classList.add("visible");

    document.getElementById("deck-name").textContent = decks[currentDeckIndex].name;
    resetCheckboxes();

    sectionIndex = index;
    startTime = Date.now();

    // При показе второго раздела — обновляем изображения
    if (sectionIndex === 1) {
      updateImages();
      // setTimeout(() => nextSection(), 1200);
    }
  }

  function nextSection() {
  const timeSpent = ((Date.now() - startTime) / 1000).toFixed(2);
  const checkboxes = document.querySelectorAll(".section.visible input[type='checkbox']:checked");
  const selected = Array.from(checkboxes).map(cb => cb.value);

  // Сохраняем результат как объект
  results.push({
    deck: currentDeckIndex,
    section: sectionIndex,
    time: parseFloat(timeSpent),
    answers: selected.length ? selected : ["Нет"]
  });

  // Переход к следующему разделу
  if (sectionIndex === 4) {
    currentDeckIndex++;
    if (currentDeckIndex < decks.length) {
      showSection(0);
    } else {
      endTest();
    }
  } else {
    showSection(sectionIndex + 1);
  }
}
  
  function resetCheckboxes() {
    let checkboxes = document.querySelectorAll("input[type='checkbox']");
    checkboxes.forEach(cb => cb.checked = false);
  }


  //Начало новой версси енд тест
  function endTest() {
  const decksCount = decks.length;
  const correctAnswersByDeck = [
    /* твой массив правильных ответов */
     [ // Колода 1
      ["Стрит", "Флеш"],
      ["Сет"],
      ["Пара", "Две пары"]
    ],
    [ // Колода 2
      ["Стрит"],
      ["Пара", "Две пары", "Флеш"],
      ["Пара", "Две пары", "Сет", "Фулл хаус"]
    ],
    [ // Колода 3
      ["Пара"],
      ["Каре"],
      ["Пара", "Флеш"]
    ],
    [ // Колода 4
      ["Пара", "Стрит"],
      ["Пара"],
      ["Пара", "Две пары"]
    ],
    [ // Колода 5
      ["Пара", "Стрит"],
      ["Пара", "Две пары", "Сет", "Фулл хаус"],
      ["Нет"]
    ],
    [ // Колода 6
      ["Пара"],
      ["Стрит"],
      ["Пара", "Две пары"]
    ],
    [ // Колода 7
      ["Пара"],
      ["Стрит", "Флеш"],
      ["Сет"]
    ],
    [ // Колода 8
      ["Пара"],
      ["Стрит"],
      ["Сет"]
    ],
  ];

  let csv = "Колода,Время запоминания,Среднее время ответа,Точность (F1),Финальный балл\n";

  for (let i = 0; i < decksCount; i++) {
    const deckName = decks[i].name;
    const deckResults = results.filter(r => r.deck === i);
    const stats = analyzeDeck(deckResults, correctAnswersByDeck[i]);

    csv += `${deckName},${stats.memorizeTime},${stats.avgAnswerTime},${stats.avgF1},${stats.score}\n`;
  }

  // Добавляем блок "Сырые результаты"
  csv += "\nСырые ответы:\nКолода,Раздел,Время (сек),Ответы пользователя,Правильные ответы,TP,FP,FN,F1\n";

  results.forEach(r => {
    const correct = correctAnswersByDeck[r.deck]?.[r.section - 2] || [];
    const user = r.answers;

    const correctSet = new Set(correct.map(x => x.trim().toLowerCase()));
    const userSet = new Set(user.map(x => x.trim().toLowerCase()));

    const tp = [...userSet].filter(x => correctSet.has(x)).length;
    const fp = [...userSet].filter(x => !correctSet.has(x)).length;
    const fn = [...correctSet].filter(x => !userSet.has(x)).length;

    const precision = tp / (tp + fp || 1);
    const recall = tp / (tp + fn || 1);
    const f1 = tp === 0 ? 0 : (2 * precision * recall) / (precision + recall);
    const f1Score = +(f1 * 100).toFixed(2);

    csv += `К${r.deck + 1},Р${r.section + 1},${r.time},${user.join(" | ") || "Нет"},${correct.join(" | ") || "Нет"},${tp},${fp},${fn},${f1Score}\n`;
  });

  // Сохраняем CSV
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "results.csv";
  link.click();

  document.body.innerHTML = `<h1>Тест завершен!</h1><p>Результаты сохранены как файл <b>results.csv</b>.</p>`;
}

  // Конец новой версии енд тест
  

  window.onload = function () {
    sections = document.querySelectorAll(".section");
    showSection(0);
  };
</script>
</head>
<body>

   <!-- Раздел 1 -->
  <div class="section visible">
    <h1>Исследование игральных карт</h1>
    <h2>Всего тестирую 8 колод, на каждую колоду по 3 борда. В среднем тест займет около 8ми минут. Пожалуйста максимум внимания на тест, не отвлекайся!</h2>
    <p>Я покажу тебе 2 карты, как запомнишь их кликай "Далее", будем считать что ты получил их на руку. После этого ты по порядку будешь видеть борды, никуда не торопись но и особо не медли, отмечай комбинации которые получилось бы собрать, если ты можешь собрать одновременно несколько комбинаций, отмечай их тоже. Сейчас будет тестироваться <span id="deck-name">Колода 1</span></p>
    <button class="next-button" onclick="nextSection()">Начать тест</button>
  </div>

  <!-- Раздел 2 -->
  <div class="section">
    <h2>Запомни карты</h2>
    <div>
    <img src="images/cards01.png" alt="Игральные карты" />
    </div>
    <button class="next-button" onclick="nextSection()">Далее</button>
  </div>

  <!-- Раздел 3 -->
  <div class="section">
    <h2>Какие комбинации ты можешь собрать?</h2>
    <img src="images/cards02.png" alt="Игральные карты" />
    <div class="checkbox-group">
      <label class="checkbox-item"><input type="checkbox" value="Пара" /> Пара</label>
      <label class="checkbox-item"><input type="checkbox" value="Две пары" /> Две пары</label>
      <label class="checkbox-item"><input type="checkbox" value="Сет" /> Сет</label>
      <label class="checkbox-item"><input type="checkbox" value="Стрит" /> Стрит</label>
      <label class="checkbox-item"><input type="checkbox" value="Флеш" /> Флеш</label>
      <label class="checkbox-item"><input type="checkbox" value="Фулл хаус" /> Фулл хаус</label>
      <label class="checkbox-item"><input type="checkbox" value="Каре" /> Каре</label>
    </div>
    <button class="next-button" onclick="nextSection()">Далее</button>
  </div>

  <!-- Раздел 4 -->
  <div class="section">
    <h2>Какие комбинации ты можешь собрать?</h2>
    <img src="images/cards03.png" alt="Игральные карты" />
    <div class="checkbox-group">
       <label class="checkbox-item"><input type="checkbox" value="Пара" /> Пара</label>
      <label class="checkbox-item"><input type="checkbox" value="Две пары" /> Две пары</label>
      <label class="checkbox-item"><input type="checkbox" value="Сет" /> Сет</label>
      <label class="checkbox-item"><input type="checkbox" value="Стрит" /> Стрит</label>
      <label class="checkbox-item"><input type="checkbox" value="Флеш" /> Флеш</label>
      <label class="checkbox-item"><input type="checkbox" value="Фулл хаус" /> Фулл хаус</label>
      <label class="checkbox-item"><input type="checkbox" value="Каре" /> Каре</label>
    </div>
    <button class="next-button" onclick="nextSection()">Далее</button>
  </div>

  <!-- Раздел 5 -->
  <div class="section">
    <h2>Какие комбинации ты можешь собрать?</h2>
    <img src="images/cards04.png" alt="Игральные карты" />
    <div class="checkbox-group">
      <label class="checkbox-item"><input type="checkbox" value="Пара" /> Пара</label>
      <label class="checkbox-item"><input type="checkbox" value="Две пары" /> Две пары</label>
      <label class="checkbox-item"><input type="checkbox" value="Сет" /> Сет</label>
      <label class="checkbox-item"><input type="checkbox" value="Стрит" /> Стрит</label>
      <label class="checkbox-item"><input type="checkbox" value="Флеш" /> Флеш</label>
      <label class="checkbox-item"><input type="checkbox" value="Фулл хаус" /> Фулл хаус</label>
      <label class="checkbox-item"><input type="checkbox" value="Каре" /> Каре</label>
    </div>
    <button class="next-button" onclick="nextSection()">Завершить тест колоды</button>
  </div>

</body>
</html>
